#!/bin/sh -
#
HOME=/
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/hddapp/bin:/usr/hddapp/sbin:/usr/local/bin:/usr/local/sbin
export HOME PATH

. /etc/rc.conf

if [ $NETWORK_INSTALL_VERSION = "YES" -a -e /system/.newroot -a -e /system/hddapp.bz2 ]; then
    echo    "   newroot tag file found."
    echo -n "   removing old system files :"
    DIRS="spool codb usr sbin root lib etc"
    for dir in $DIRS;
    do
        echo -n "$dir "
        rm -rf /system/$dir
    done
    echo ""
    echo -n "  decompress new system files.."
    tar jxpf /system/hddapp.bz2 -C /system
    rm -f /system/.newroot
    echo "Done"
fi                                   
                   
if [ $NETWORK_INSTALL_VERSION = "YES" -a -e /system/usr/webroot ]; then                
    cp -af /sbin/*                /system/sbin
    cp -af /lib/modules/*         /system/lib/modules
    cp -af /system/etc/*          /etc
    
    cp -af /system/lib/modules/*   /lib/modules
    
    mkdir -p /system/usr/bin
    cp -af /usr/lib/*              /system/usr/lib
    cp -af /usr/sbin/*             /system/usr/sbin
    cp -af /usr/share/*            /system/usr/share
    cp -af /usr/bin/*              /system/usr/bin
    ####
    #fix busybox's links
    DIRS="/system/sbin /system/usr/sbin /system/usr/bin"
    PWD=`pwd`
    
    #fix busybox's link
    for DIR in $DIRS;
    do
        cd $DIR
        files=`ls -1 *`     
        for thisf in $files ;
        do
          if ls -l $thisf |grep -q busybox >/dev/null ; then
             ##echo "file=$thisf"
             ln -sf /bin/busybox $thisf
          fi
        done
    done
    
    cd $PWD
    ####
    rm -rf /sbin
    ln -s /system/sbin          /sbin
    rm -rf /usr
    ln -s /system/usr           /usr
    
    rm -rf /lib/modules
    ln -s  /system/lib/modules  /lib/modules
    
fi